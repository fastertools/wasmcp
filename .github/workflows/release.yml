name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-wasip1
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Install cargo-binstall
      uses: cargo-bins/cargo-binstall@main
    
    - name: Install tools
      run: make install-rust-tools
    
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    # Build all components
    - name: Build all components
      run: make build-all
    
    - name: Get versions
      id: versions
      run: |
        echo "gateway=$(make get-gateway-version)" >> $GITHUB_OUTPUT
        echo "rust_sdk=$(make get-rust-sdk-version)" >> $GITHUB_OUTPUT
        echo "ts_sdk=$(make get-ts-sdk-version)" >> $GITHUB_OUTPUT
    
    - name: Login to GitHub Container Registry
      run: |
        echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
    
    - name: Publish wasmcp-spin to GitHub Container Registry
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: make publish-gateway
    
    # Publish wasmcp-rust to crates.io
    - name: Publish wasmcp-rust to crates.io
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: make publish-rust-sdk
    
    # Publish wasmcp-typescript to npm
    - name: Setup TypeScript SDK
      run: make install-ts-deps
    
    - name: Publish wasmcp-typescript to npm
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: make publish-ts-sdk
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Release ${{ github.ref_name }}
        generate_release_notes: true
        files: |
          src/components/wasmcp-spin/target/wasm32-wasip1/release/wasmcp_spin.wasm
        body: |
          ## Published Packages
          
          ### WebAssembly Component
          Use the published component in your `spin.toml`:
          
          ```toml
          [component.wasmcp-spin]
          source = { registry = "ghcr.io", package = "fastertools:wasmcp-spin", version = "${{ steps.versions.outputs.gateway }}" }
          ```
          
          ### Rust SDK
          Add to your `Cargo.toml`:
          ```toml
          [dependencies]
          wasmcp = "${{ steps.versions.outputs.rust_sdk }}"
          ```
          
          ### TypeScript SDK
          Install via npm:
          ```bash
          npm install wasmcp@${{ steps.versions.outputs.ts_sdk }}
          ```